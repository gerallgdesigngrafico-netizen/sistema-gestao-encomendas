<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sistema de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-cash-register text-green-600 mr-2"></i>
                        Ponto de Venda (PDV)
                    </h1>
                </div>
                <button onclick="logout()" class="text-red-600 hover:text-red-700">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Produtos -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Busca de Produtos -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchProduto"
                            placeholder="Buscar produto por nome ou referência..."
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                            oninput="filterProdutos()"
                        >
                        <i class="fas fa-search absolute left-3 top-4 text-gray-400"></i>
                    </div>
                </div>

                <!-- Grid de Produtos -->
                <div id="produtosGrid" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Produtos serão renderizados aqui -->
                </div>
            </div>

            <!-- Carrinho -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-lg border border-gray-200 sticky top-4">
                    <!-- Cliente -->
                    <div class="p-4 border-b border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <select id="clienteSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">Cliente Anônimo</option>
                        </select>
                    </div>

                    <!-- Itens do Carrinho -->
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-shopping-cart text-green-600 mr-2"></i>
                            Carrinho
                        </h3>
                        <div id="carrinhoList" class="space-y-3 max-h-[400px] overflow-y-auto">
                            <!-- Itens do carrinho serão renderizados aqui -->
                        </div>
                        <div id="carrinhoEmpty" class="text-center py-8 text-gray-400">
                            <i class="fas fa-shopping-cart text-4xl mb-2"></i>
                            <p>Carrinho vazio</p>
                        </div>
                    </div>

                    <!-- Totais -->
                    <div class="p-4 border-b border-gray-200 bg-gray-50">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal:</span>
                                <span id="subtotal" class="font-semibold">€0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Desconto:</span>
                                <span id="desconto" class="font-semibold text-red-600">€0.00</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold border-t border-gray-300 pt-2">
                                <span>Total:</span>
                                <span id="total" class="text-green-600">€0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="p-4 space-y-2">
                        <button onclick="limparCarrinho()" class="w-full bg-red-100 hover:bg-red-200 text-red-700 py-3 rounded-lg font-semibold">
                            <i class="fas fa-trash mr-2"></i>Limpar Carrinho
                        </button>
                        <button onclick="finalizarVenda()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold text-lg">
                            <i class="fas fa-check mr-2"></i>Finalizar Venda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Finalizar Venda -->
    <div id="finalizarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-cash-register text-green-600 mr-2"></i>
                        Finalizar Venda
                    </h2>
                    <button onclick="closeFinalizarModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Total -->
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Total a Pagar</p>
                        <p id="totalFinal" class="text-3xl font-bold text-green-600">€0.00</p>
                    </div>

                    <!-- Método de Pagamento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Método de Pagamento *</label>
                        <select id="metodoPagamento" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="MB WAY">MB WAY</option>
                            <option value="Multibanco">Multibanco</option>
                            <option value="Transferência">Transferência</option>
                        </select>
                    </div>

                    <!-- Valor Recebido (apenas para Dinheiro) -->
                    <div id="dinheiroSection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Valor Recebido (€)</label>
                        <input 
                            type="number" 
                            id="valorRecebido"
                            step="0.01"
                            min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                            oninput="calcularTroco()"
                        >
                        <div id="trocoInfo" class="hidden mt-2 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-gray-600">Troco:</p>
                            <p id="trocoValor" class="text-xl font-bold text-blue-600">€0.00</p>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="flex gap-3 pt-4">
                        <button onclick="confirmarVenda()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold">
                            <i class="fas fa-check mr-2"></i>Confirmar
                        </button>
                        <button onclick="closeFinalizarModal()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Verificar autenticação
        const session = localStorage.getItem('encomendas_session') || sessionStorage.getItem('encomendas_session');
        if (!session) {
            window.location.href = 'login.html';
        }

        let allProdutos = [];
        let carrinho = [];

        // Logout
        function logout() {
            localStorage.removeItem('encomendas_session');
            sessionStorage.removeItem('encomendas_session');
            window.location.href = 'login.html';
        }

        // Carregar dados iniciais
        window.addEventListener('DOMContentLoaded', () => {
            loadClientes();
            loadProdutos();
            
            // Controlar campo de dinheiro
            document.getElementById('metodoPagamento').addEventListener('change', function() {
                const dinheiroSection = document.getElementById('dinheiroSection');
                if (this.value === 'Dinheiro') {
                    dinheiroSection.classList.remove('hidden');
                } else {
                    dinheiroSection.classList.add('hidden');
                    document.getElementById('trocoInfo').classList.add('hidden');
                }
            });
        });

        // Carregar clientes
        function loadClientes() {
            const clientes = JSON.parse(localStorage.getItem('clientes') || '[]');
            const select = document.getElementById('clienteSelect');
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nome} (${cliente.tipo})`;
                select.appendChild(option);
            });
        }

        // Carregar produtos
        function loadProdutos() {
            allProdutos = JSON.parse(localStorage.getItem('produtos') || '[]');
            renderProdutos();
        }

        // Renderizar produtos
        function renderProdutos() {
            const grid = document.getElementById('produtosGrid');
            const searchTerm = document.getElementById('searchProduto').value.toLowerCase();

            const filtered = allProdutos.filter(p => 
                p.nome.toLowerCase().includes(searchTerm) ||
                (p.referencia && p.referencia.toLowerCase().includes(searchTerm))
            );

            grid.innerHTML = filtered.map(produto => `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="adicionarAoCarrinho(${produto.id})">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-lg mx-auto mb-3 flex items-center justify-center">
                            <i class="fas fa-box text-2xl text-gray-400"></i>
                        </div>
                        <h4 class="font-semibold text-gray-900 mb-1">${produto.nome}</h4>
                        ${produto.referencia ? `<p class="text-xs text-gray-500 mb-2">${produto.referencia}</p>` : ''}
                        <p class="text-lg font-bold text-green-600">€${parseFloat(produto.preco_base_b2c).toFixed(2)}</p>
                        <p class="text-xs text-gray-500 mt-1">Stock: ${produto.stock || 0}</p>
                    </div>
                </div>
            `).join('');
        }

        // Filtrar produtos
        function filterProdutos() {
            renderProdutos();
        }

        // Adicionar ao carrinho
        function adicionarAoCarrinho(produtoId) {
            const produto = allProdutos.find(p => p.id === produtoId);
            if (!produto) return;

            const itemExistente = carrinho.find(item => item.id === produtoId);
            
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                carrinho.push({
                    id: produto.id,
                    nome: produto.nome,
                    preco: parseFloat(produto.preco_base_b2c),
                    quantidade: 1
                });
            }

            renderCarrinho();
        }

        // Renderizar carrinho
        function renderCarrinho() {
            const list = document.getElementById('carrinhoList');
            const empty = document.getElementById('carrinhoEmpty');

            if (carrinho.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                atualizarTotais();
                return;
            }

            empty.classList.add('hidden');

            list.innerHTML = carrinho.map(item => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900 text-sm">${item.nome}</p>
                        <p class="text-xs text-gray-500">€${item.preco.toFixed(2)} x ${item.quantidade}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="alterarQuantidade(${item.id}, -1)" class="w-7 h-7 bg-red-100 hover:bg-red-200 text-red-600 rounded">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span class="w-8 text-center font-semibold">${item.quantidade}</span>
                        <button onclick="alterarQuantidade(${item.id}, 1)" class="w-7 h-7 bg-green-100 hover:bg-green-200 text-green-600 rounded">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                        <button onclick="removerDoCarrinho(${item.id})" class="w-7 h-7 bg-red-500 hover:bg-red-600 text-white rounded ml-1">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            atualizarTotais();
        }

        // Alterar quantidade
        function alterarQuantidade(produtoId, delta) {
            const item = carrinho.find(i => i.id === produtoId);
            if (!item) return;

            item.quantidade += delta;

            if (item.quantidade <= 0) {
                removerDoCarrinho(produtoId);
            } else {
                renderCarrinho();
            }
        }

        // Remover do carrinho
        function removerDoCarrinho(produtoId) {
            carrinho = carrinho.filter(item => item.id !== produtoId);
            renderCarrinho();
        }

        // Limpar carrinho
        function limparCarrinho() {
            if (carrinho.length === 0) return;
            if (!confirm('Deseja limpar o carrinho?')) return;
            
            carrinho = [];
            renderCarrinho();
        }

        // Atualizar totais
        function atualizarTotais() {
            const subtotal = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const desconto = 0; // Pode adicionar lógica de desconto
            const total = subtotal - desconto;

            document.getElementById('subtotal').textContent = `€${subtotal.toFixed(2)}`;
            document.getElementById('desconto').textContent = `€${desconto.toFixed(2)}`;
            document.getElementById('total').textContent = `€${total.toFixed(2)}`;
        }

        // Finalizar venda
        function finalizarVenda() {
            if (carrinho.length === 0) {
                alert('⚠️ Carrinho vazio!');
                return;
            }

            const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            document.getElementById('totalFinal').textContent = `€${total.toFixed(2)}`;
            document.getElementById('finalizarModal').classList.remove('hidden');
        }

        // Fechar modal
        function closeFinalizarModal() {
            document.getElementById('finalizarModal').classList.add('hidden');
            document.getElementById('dinheiroSection').classList.add('hidden');
            document.getElementById('trocoInfo').classList.add('hidden');
            document.getElementById('valorRecebido').value = '';
        }

        // Calcular troco
        function calcularTroco() {
            const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);
            const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
            const troco = recebido - total;

            if (troco >= 0) {
                document.getElementById('trocoValor').textContent = `€${troco.toFixed(2)}`;
                document.getElementById('trocoInfo').classList.remove('hidden');
            } else {
                document.getElementById('trocoInfo').classList.add('hidden');
            }
        }

        // Confirmar venda
        function confirmarVenda() {
            const clienteId = document.getElementById('clienteSelect').value;
            const metodo = document.getElementById('metodoPagamento').value;
            const total = carrinho.reduce((sum, item) => sum + (item.preco * item.quantidade), 0);

            // Validar dinheiro
            if (metodo === 'Dinheiro') {
                const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
                if (recebido < total) {
                    alert('⚠️ Valor recebido insuficiente!');
                    return;
                }
            }

            // Criar encomenda para cada item
            const encomendas = JSON.parse(localStorage.getItem('encomendas') || '[]');
            const pagamentos = JSON.parse(localStorage.getItem('pagamentos') || '[]');

            carrinho.forEach(item => {
                const encomenda = {
                    id: Date.now() + Math.random(),
                    cliente_id: clienteId || null,
                    produto_id: item.id,
                    quantidade: item.quantidade,
                    valor_unitario: item.preco,
                    estado: 'Entregue',
                    data_entrega: new Date().toISOString().split('T')[0],
                    observacoes: `Venda PDV - ${metodo}`,
                    created_at: new Date().toISOString()
                };
                encomendas.push(encomenda);

                // Criar pagamento
                const pagamento = {
                    id: Date.now() + Math.random(),
                    encomenda_id: encomenda.id,
                    valor: item.preco * item.quantidade,
                    metodo: metodo,
                    data_pagamento: new Date().toISOString().split('T')[0],
                    referencia: `PDV-${Date.now()}`,
                    observacoes: 'Venda PDV',
                    created_at: new Date().toISOString()
                };
                pagamentos.push(pagamento);
            });

            localStorage.setItem('encomendas', JSON.stringify(encomendas));
            localStorage.setItem('pagamentos', JSON.stringify(pagamentos));

            alert('✅ Venda finalizada com sucesso!');
            
            carrinho = [];
            renderCarrinho();
            closeFinalizarModal();
        }
    </script>
</body>
</html>
